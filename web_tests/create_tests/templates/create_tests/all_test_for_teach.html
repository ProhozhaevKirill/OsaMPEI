{% extends 'create_tests/header.html' %}

{% load static %}
{% load my_filters %}

{% block title %}Управление тестами{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/all_test_for_teach.css' %}">
    <link rel="stylesheet" href="{% static 'libs/fontawesome/css/all.min.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/all_test_for_teach.js' %}" defer></script>
{% endblock %}

{% block content %}
<!-- Добавляем CSRF токен для AJAX запросов -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="container">
    <div class="header">
        <h1><i class="fas fa-tasks"></i> Управление тестами</h1>
        <div class="actions">
            <a href="{% url 'create_tests:create_test' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Создать тест
            </a>
            <button class="btn btn-secondary" id="createGroupListBtn">
                <i class="fas fa-list"></i> Сформировать набор групп
            </button>
        </div>
    </div>

    <div class="search-filter">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="testSearch" placeholder="Поиск тестов...">
        </div>
        <div class="filter-box">
            <select id="authorFilter" onchange="handleAuthorFilter()">
                <option value="my" {% if filter_type == "my" %}selected{% endif %}>Мои тесты</option>
                <option value="all" {% if filter_type == "all" %}selected{% endif %}>Все тесты</option>
            </select>
            <select id="testFilter">
                <option value="all">Все</option>
                <option value="published">Опубликованные</option>
                <option value="unpublished">Неопубликованные</option>
            </select>
        </div>
    </div>

    <div class="tests-container">
        {% if tests %}
            <ul class="tests-list">
                {% if filter_type == "all" %}
                    <!-- Сначала показываем тесты преподавателя -->
                    {% for test in tests %}
                        {% if test.creator == current_teacher %}
                        <li class="test-card" data-slug="{{ test.name_slug_tests }}" data-published="{% if test.is_published %}true{% else %}false{% endif %}">
                            <div class="test-main">
                                <div class="test-info">
                                    <div class="base_info">
                                        <span class="test-subj">{{ forloop.counter }}. {{ test.name_tests }}.</span>
                                        <span class="test-number">Предмет: {{ test.subj }}.</span>
                                    </div>
                                    <div class="test-meta">
                                        <span><i class="fas fa-user"></i>Автор: {{ test.creator.first_name }} {{ test.creator.middle_name }}</span>
                                        <span><i class="fas fa-users"></i>
                                            Доступ:
                                            {% with found=0 %}
                                                {% for pub in published %}
                                                    {% if pub.test_name.id == test.id %}
                                                        {{ pub.group_name.name }}
                                                        {% with found=1 %}{% endwith %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% if not test.is_published %}Ограничен{% endif %}
                                            {% endwith %}
                                        </span>
                                    </div>
                                </div>
                                <div class="test-actions">
                                    <a href="{% url 'create_tests:some_test' test.name_slug_tests %}" class="btn btn-watch">
                                        <i class="fa-solid fa-eye"></i> Посмотреть
                                    </a>
                                    <a href="{% url 'create_tests:solve_test' test.name_slug_tests %}" class="btn btn-info">
                                        <i class="fas fa-play"></i> Решить
                                    </a>

                                    <!-- Действия для собственных тестов -->
                                    {% if not test.is_published %}
                                        <button class="btn btn-publish publish-btn"
                                                data-slug="{{ test.name_slug_tests }}"
                                                data-url="{% url 'create_tests:publish_test' test.name_slug_tests %}">
                                            <i class="fas fa-share-square"></i> Опубликовать
                                        </button>

                                        <button class="btn btn-danger delete-btn"
                                                data-slug="{{ test.name_slug_tests }}"
                                                data-url="{% url 'create_tests:delete_test' test.name_slug_tests %}">
                                            <i class="fas fa-trash-alt"></i> Удалить
                                        </button>
                                        <a href="{% url 'create_tests:edit_test' test.name_slug_tests %}" class="btn btn-edit">
                                            <i class="fas fa-edit"></i> Редактировать
                                        </a>
                                    {% else %}
                                        <button class="btn btn-unpublish unpublish-btn"
                                                data-url="{% url 'create_tests:unpublish_test' test.name_slug_tests %}">
                                            <i class="fa-solid fa-eye-slash"></i> Снять с публикации
                                        </button>
                                        <div class="edit-disabled-notice" style="width: 215px;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            <span>Изменения недоступны</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if test.description %}
                            <div class="test-description">
                                <p>{{ test.description }}</p>
                            </div>
                            {% endif %}
                        </li>
                        {% endif %}
                    {% endfor %}

                    <!-- Затем тесты других преподавателей -->
                    {% for test in tests %}
                        {% if test.creator != current_teacher %}
                        <li class="test-card" data-slug="{{ test.name_slug_tests }}" data-published="{% if test.is_published %}true{% else %}false{% endif %}">
                            <div class="test-main">
                                <div class="test-info">
                                    <div class="base_info">
                                        <span class="test-subj">{{ forloop.counter }}. {{ test.name_tests }}.</span>
                                        <span class="test-number">Предмет: {{ test.subj }}.</span>
                                    </div>
                                    <div class="test-meta">
                                        <span><i class="fas fa-user"></i>
                                            Автор: {{ test.creator.first_name }} {{ test.creator.middle_name }}
                                            <span class="external-author">(чужой тест)</span>
                                        </span>
                                        <span><i class="fas fa-users"></i>
                                            Доступ:
                                            {% with found=0 %}
                                                {% for pub in published %}
                                                    {% if pub.test_name.id == test.id %}
                                                        {{ pub.group_name.name }}
                                                        {% with found=1 %}{% endwith %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% if not test.is_published %}Ограничен{% endif %}
                                            {% endwith %}
                                        </span>
                                    </div>
                                </div>
                                <div class="test-actions">
                                    <a href="{% url 'create_tests:some_test' test.name_slug_tests %}" class="btn btn-watch">
                                        <i class="fa-solid fa-eye"></i> Посмотреть
                                    </a>
                                    <a href="{% url 'create_tests:solve_test' test.name_slug_tests %}" class="btn btn-info">
                                        <i class="fas fa-play"></i> Решить
                                    </a>

                                    <!-- Действия для чужих тестов - только просмотр -->
                                    <div class="external-test-notice">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Чужой тест - только просмотр</span>
                                    </div>
                                </div>
                            </div>
                            {% if test.description %}
                            <div class="test-description">
                                <p>{{ test.description }}</p>
                            </div>
                            {% endif %}
                        </li>
                        {% endif %}
                    {% endfor %}

                {% elif filter_type == "my" %}
                    <!-- Только мои тесты -->
                    {% for test in tests %}
                        {% if test.creator == current_teacher %}
                        <li class="test-card" data-slug="{{ test.name_slug_tests }}" data-published="{% if test.is_published %}true{% else %}false{% endif %}">
                            <div class="test-main">
                                <div class="test-info">
                                    <div class="base_info">
                                        <span class="test-subj">{{ forloop.counter }}. {{ test.name_tests }}.</span>
                                        <span class="test-number">Предмет: {{ test.subj }}.</span>
                                    </div>
                                    <div class="test-meta">
                                        <span><i class="fas fa-user"></i>Автор: {{ test.creator.first_name }} {{ test.creator.middle_name }}</span>
                                        <span><i class="fas fa-users"></i>
                                            Доступ:
                                            {% with found=0 %}
                                                {% for pub in published %}
                                                    {% if pub.test_name.id == test.id %}
                                                        {{ pub.group_name.name }}
                                                        {% with found=1 %}{% endwith %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% if not test.is_published %}Ограничен{% endif %}
                                            {% endwith %}
                                        </span>
                                    </div>
                                </div>
                                <div class="test-actions">
                                    <a href="{% url 'create_tests:some_test' test.name_slug_tests %}" class="btn btn-watch">
                                        <i class="fa-solid fa-eye"></i> Посмотреть
                                    </a>
                                    <a href="{% url 'create_tests:solve_test' test.name_slug_tests %}" class="btn btn-info">
                                        <i class="fas fa-play"></i> Решить
                                    </a>

                                    <!-- Действия для собственных тестов -->
                                    {% if not test.is_published %}
                                        <button class="btn btn-publish publish-btn"
                                                data-slug="{{ test.name_slug_tests }}"
                                                data-url="{% url 'create_tests:publish_test' test.name_slug_tests %}">
                                            <i class="fas fa-share-square"></i> Опубликовать
                                        </button>

                                        <button class="btn btn-danger delete-btn"
                                                data-slug="{{ test.name_slug_tests }}"
                                                data-url="{% url 'create_tests:delete_test' test.name_slug_tests %}">
                                            <i class="fas fa-trash-alt"></i> Удалить
                                        </button>
                                        <a href="{% url 'create_tests:edit_test' test.name_slug_tests %}" class="btn btn-edit">
                                            <i class="fas fa-edit"></i> Редактировать
                                        </a>
                                    {% else %}
                                        <button class="btn btn-unpublish unpublish-btn"
                                                data-url="{% url 'create_tests:unpublish_test' test.name_slug_tests %}">
                                            <i class="fa-solid fa-eye-slash"></i> Снять с публикации
                                        </button>
                                        <div class="edit-disabled-notice" style="width: 215px;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            <span>Изменения недоступны</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if test.description %}
                            <div class="test-description">
                                <p>{{ test.description }}</p>
                            </div>
                            {% endif %}
                        </li>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </ul>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-tasks fa-4x"></i>
                <h3>У вас пока нет тестов</h3>
                <p>Создайте свой первый тест, нажав кнопку "Создать тест"</p>
                <a href="{% url 'create_tests:create_test' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Создать тест
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Подтверждение удаления </h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Вы уверены, что хотите удалить этот тест? Это действие нельзя отменить.</p>
            <p class="warning-text"><i class="fas fa-exclamation-circle"></i> Все результаты студентов по этому тесту также будут удалены!</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary cancel-delete">Отмена</button>
            <button class="btn btn-danger confirm-delete">Удалить</button>
        </div>
    </div>
</div>

<!-- Модальное окно публикации теста -->
<div id="publishModal" class="modal">
    <div class="modal-content wide">
        <div class="modal-header">
            <h3><i class="fas fa-share-square"></i> Настройки публикации теста</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="groupsSection" class="groups-section">
                <div class="search-filter-row">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="groupSearch" placeholder="Поиск групп...">
                    </div>
                    <div class="filter-controls">
                        <select id="educationLevelFilter" class="filter-select">
                            <option value="">Все уровни</option>
                            <option value="bachelor">Бакалавриат</option>
                            <option value="master">Магистратура</option>
                        </select>
                        <select id="courseFilter" class="filter-select">
                            <option value="">Все курсы</option>
                            <option value="1">1 курс</option>
                            <option value="2">2 курс</option>
                            <option value="3">3 курс</option>
                            <option value="4">4 курс</option>
                        </select>
                        <button class="btn btn-info" id="loadSavedGroupsBtn">
                            <i class="fas fa-bookmark"></i> Мои наборы
                        </button>
                    </div>
                </div>

                <!-- Сохраненные списки групп -->
                <div id="savedGroupsSection" class="saved-groups-section" style="display: none;">
                    <h4><i class="fas fa-bookmark"></i> Сохраненные наборы групп:</h4>
                    <div id="savedGroupsList" class="saved-groups-list">
                        <!-- Здесь будут загружаться сохраненные списки -->
                    </div>
                </div>

                <div class="groups-container">
                    <div class="institutes-list">
                        {% for institute in institutes %}
                        <div class="institute-card" data-id="{{ institute.id }}">
                            <div class="institute-header">
                                <div class="institute-info">
                                    <span class="full-name">{{ institute.name }}</span>
                                </div>
                                <div class="institute-actions">
                                    <span class="groups-count">групп: {{ institute.studentgroup_set.all.count }}</span>
                                    <button class="btn btn-toggle">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="groups-list">
                                {% for all_groups in institute.studentgroup_set.all %}
                                <div class="group-item"
                                     data-education-level="{{ all_groups.education_level }}"
                                     data-course="{{ all_groups.course }}">
                                    <div class="form-check">
                                        <input type="checkbox" name="groups" class="form-check-input group-checkbox"
                                               id="group-{{ all_groups.id }}" value="{{ all_groups.id }}">

                                        <label class="form-check-label" for="group-{{ all_groups.id }}">
                                            {{ all_groups.name }}
                                            <span class="group-info">
                                                ({{ all_groups.get_education_level_display }}, {{ all_groups.get_course_display }})
                                            </span>
                                            <span class="students-count">(студентов: {{ all_groups.students.count }})</span>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary cancel-publish">Отмена</button>
            <button class="btn btn-primary confirm-publish">
                <i class="fas fa-share-square"></i> Опубликовать тест
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно создания набора групп -->
<div id="groupSetModal" class="modal">
    <div class="modal-content wide">
        <div class="modal-header">
            <h3><i class="fas fa-list"></i> Создать набор групп</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="groupSetName">Название набора:</label>
                <input type="text" id="groupSetName" class="form-control" placeholder="Введите название набора групп">
            </div>

            <div class="groups-selection">
                <div class="search-filter-row">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="groupSetSearch" placeholder="Поиск групп...">
                    </div>
                    <div class="filter-controls">
                        <select id="groupSetEducationFilter" class="filter-select">
                            <option value="">Все уровни</option>
                            <option value="bachelor">Бакалавриат</option>
                            <option value="master">Магистратура</option>
                        </select>
                        <select id="groupSetCourseFilter" class="filter-select">
                            <option value="">Все курсы</option>
                            <option value="1">1 курс</option>
                            <option value="2">2 курс</option>
                            <option value="3">3 курс</option>
                            <option value="4">4 курс</option>
                        </select>
                    </div>
                </div>

                <div class="groups-container">
                    <div class="institutes-list">
                        {% for institute in institutes %}
                        <div class="institute-card" data-id="{{ institute.id }}">
                            <div class="institute-header">
                                <div class="institute-info">
                                    <span class="full-name">{{ institute.name }}</span>
                                </div>
                                <div class="institute-actions">
                                    <span class="groups-count">групп: {{ institute.studentgroup_set.all.count }}</span>
                                    <button class="btn btn-toggle">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="groups-list">
                                {% for group in institute.studentgroup_set.all %}
                                <div class="group-item"
                                     data-education-level="{{ group.education_level }}"
                                     data-course="{{ group.course }}">
                                    <div class="form-check">
                                        <input type="checkbox" name="groupset_groups" class="form-check-input groupset-checkbox"
                                               id="groupset-{{ group.id }}" value="{{ group.id }}">
                                        <label class="form-check-label" for="groupset-{{ group.id }}">
                                            {{ group.name }}
                                            <span class="group-info">
                                                ({{ group.get_education_level_display }}, {{ group.get_course_display }})
                                            </span>
                                            <span class="students-count">(студентов: {{ group.students.count }})</span>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="selected-groups-preview">
                <h4>Выбранные группы: <span id="selectedGroupsCount">0</span></h4>
                <div id="selectedGroupsList" class="selected-groups-list">
                    <!-- Здесь будут отображаться выбранные группы -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelGroupSet">Отмена</button>
            <button class="btn btn-primary" id="saveGroupSet">
                <i class="fas fa-save"></i> Сохранить набор
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно успешного сохранения -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-check-circle"></i> Успешно сохранено</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Набор групп успешно сохранен!</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary close-success">ОК</button>
        </div>
    </div>
</div>

<div class="modal-overlay"></div>

<script>
// Функция для обработки фильтра по автору
function handleAuthorFilter() {
    const filterType = document.getElementById('authorFilter').value;
    const url = new URL(window.location);
    url.searchParams.set('filter', filterType);
    window.location.href = url.toString();
}

// Простая функция для открытия модального окна
function openGroupModal() {
    console.log('openGroupModal called');
    const modal = document.getElementById('groupSetModal');
    const overlay = document.querySelector('.modal-overlay');
    if (modal) {
        modal.classList.add('active');
        console.log('Modal opened via function');
    }
    if (overlay) {
        overlay.classList.add('active');
        console.log('Overlay shown via function');
    }
}

// Основная функция инициализации
function initializeModalHandlers() {
    // Закрытие модальных окон
    const closeModal = function() {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
        const overlay = document.querySelector('.modal-overlay');
        if (overlay) overlay.classList.remove('active');
    };

    // Обработчики закрытия
    const closeButtons = document.querySelectorAll('.close-modal, #cancelGroupSet, .close-success');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    const overlay = document.querySelector('.modal-overlay');
    if (overlay) {
        overlay.addEventListener('click', closeModal);
    }

    // Обработчик для кнопки создания группы
    const createBtn = document.getElementById('createGroupListBtn');
    if (createBtn && !createBtn.hasAttribute('data-handler-added')) {
        createBtn.setAttribute('data-handler-added', 'true');
        createBtn.addEventListener('click', function(e) {
            console.log('Button clicked!');
            e.preventDefault();
            openGroupModal();
        });
    }
}

// Функции для работы с группами (общие для jQuery и pure JS)
function updateSelectedGroups() {
    if (typeof $ !== 'undefined') {
        const selectedGroups = $('.groupset-checkbox:checked');
        const count = selectedGroups.length;

        $('#selectedGroupsCount').text(count);

        const selectedList = $('#selectedGroupsList');
        selectedList.empty();

        selectedGroups.each(function() {
            const label = $(this).next('label').clone();
            const groupId = $(this).val();
            const groupItem = $('<div class="selected-group-item"></div>');
            groupItem.append(label);
            groupItem.append(`<button class="btn btn-sm btn-danger remove-group" data-group-id="${groupId}"><i class="fas fa-times"></i></button>`);
            selectedList.append(groupItem);
        });
    } else {
        // Pure JS реализация
        const selectedGroups = document.querySelectorAll('.groupset-checkbox:checked');
        const count = selectedGroups.length;

        const countElement = document.getElementById('selectedGroupsCount');
        if (countElement) countElement.textContent = count;

        const selectedList = document.getElementById('selectedGroupsList');
        if (selectedList) {
            selectedList.innerHTML = '';

            selectedGroups.forEach(checkbox => {
                const label = checkbox.nextElementSibling.cloneNode(true);
                const groupId = checkbox.value;
                const groupItem = document.createElement('div');
                groupItem.className = 'selected-group-item';
                groupItem.appendChild(label);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger remove-group';
                removeBtn.setAttribute('data-group-id', groupId);
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                groupItem.appendChild(removeBtn);

                selectedList.appendChild(groupItem);
            });
        }
    }
}

// Проверяем наличие jQuery и добавляем обработчики
if (typeof $ !== 'undefined') {
    $(document).ready(function() {
        // Открытие модального окна создания набора групп
        $('#createGroupListBtn').on('click', function() {
            $('#groupSetModal').addClass('active');
            $('.modal-overlay').addClass('active');
        });

        // Закрытие модальных окон
        $('.close-modal, #cancelGroupSet, .modal-overlay').on('click', function(e) {
            if (e.target === this) {
                $('.modal').removeClass('active');
                $('.modal-overlay').removeClass('active');
            }
        });

        $('.close-success').on('click', function() {
            $('#successModal').removeClass('active');
            $('.modal-overlay').removeClass('active');
        });

        // Переключение институтов
        $('.btn-toggle').on('click', function() {
            const instituteCard = $(this).closest('.institute-card');
            const groupsList = instituteCard.find('.groups-list');
            const icon = $(this).find('i');

            groupsList.toggle();
            icon.toggleClass('fa-chevron-down fa-chevron-up');
        });

        // Отслеживание выбранных групп
        $('.groupset-checkbox').on('change', function() {
            updateSelectedGroups();
        });

        // Поиск групп
        $('#groupSetSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.group-item').each(function() {
                const groupName = $(this).find('label').text().toLowerCase();
                if (groupName.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Фильтрация по уровню образования
        $('#groupSetEducationFilter').on('change', function() {
            const selectedLevel = $(this).val();
            $('.group-item').each(function() {
                const itemLevel = $(this).data('education-level');
                if (!selectedLevel || itemLevel === selectedLevel) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Фильтрация по курсу
        $('#groupSetCourseFilter').on('change', function() {
            const selectedCourse = $(this).val();
            $('.group-item').each(function() {
                const itemCourse = $(this).data('course').toString();
                if (!selectedCourse || itemCourse === selectedCourse) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Удаление группы из выбранных
        $(document).on('click', '.remove-group', function() {
            const groupId = $(this).data('group-id');
            $(`#groupset-${groupId}`).prop('checked', false);
            updateSelectedGroups();
        });

        // Сохранение набора групп
        $('#saveGroupSet').on('click', function() {
            const groupSetName = $('#groupSetName').val().trim();
            const selectedGroups = $('.groupset-checkbox:checked').map(function() {
                return $(this).val();
            }).get();

            if (!groupSetName) {
                alert('Пожалуйста, введите название набора групп');
                return;
            }

            if (selectedGroups.length === 0) {
                alert('Пожалуйста, выберите хотя бы одну группу');
                return;
            }

            // Отправка данных на сервер
            const formData = new FormData();
            formData.append('name', groupSetName);
            selectedGroups.forEach(function(groupId) {
                formData.append('groups', groupId);
            });
            formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}');

            $.ajax({
                url: '{% url "create_tests:save_group_set" %}',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#groupSetModal').removeClass('active');
                        $('#successModal').addClass('active');

                        // Очистка формы
                        $('#groupSetName').val('');
                        $('.groupset-checkbox').prop('checked', false);
                        updateSelectedGroups();
                    } else {
                        alert('Ошибка при сохранении: ' + (response.error || 'Неизвестная ошибка'));
                    }
                },
                error: function() {
                    alert('Ошибка при отправке данных на сервер');
                }
            });
        });

        // Инициализация при использовании jQuery
        initializeModalHandlers();
    });
} else {
    // Fallback на чистый JavaScript если jQuery не загружен
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing pure JS handlers...');

        // Инициализация основных обработчиков модальных окон
        initializeModalHandlers();

        // Обработчики для pure JS функциональности
        const groupCheckboxes = document.querySelectorAll('.groupset-checkbox');
        groupCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedGroups);
        });

        // Обработчик удаления групп
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-group')) {
                const removeBtn = e.target.closest('.remove-group');
                const groupId = removeBtn.getAttribute('data-group-id');
                const checkbox = document.getElementById(`groupset-${groupId}`);
                if (checkbox) {
                    checkbox.checked = false;
                    updateSelectedGroups();
                }
            }
        });

        // Поиск групп
        const searchInput = document.getElementById('groupSetSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const groupItems = document.querySelectorAll('.group-item');

                groupItems.forEach(item => {
                    const label = item.querySelector('label');
                    const groupName = label ? label.textContent.toLowerCase() : '';
                    if (groupName.includes(searchTerm)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Фильтрация по уровню образования
        const educationFilter = document.getElementById('groupSetEducationFilter');
        if (educationFilter) {
            educationFilter.addEventListener('change', function() {
                const selectedLevel = this.value;
                const groupItems = document.querySelectorAll('.group-item');

                groupItems.forEach(item => {
                    const itemLevel = item.getAttribute('data-education-level');
                    if (!selectedLevel || itemLevel === selectedLevel) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Фильтрация по курсу
        const courseFilter = document.getElementById('groupSetCourseFilter');
        if (courseFilter) {
            courseFilter.addEventListener('change', function() {
                const selectedCourse = this.value;
                const groupItems = document.querySelectorAll('.group-item');

                groupItems.forEach(item => {
                    const itemCourse = item.getAttribute('data-course');
                    if (!selectedCourse || itemCourse === selectedCourse) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Переключение институтов
        const toggleButtons = document.querySelectorAll('.btn-toggle');
        toggleButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const instituteCard = this.closest('.institute-card');
                const groupsList = instituteCard.querySelector('.groups-list');
                const icon = this.querySelector('i');

                if (groupsList && icon) {
                    groupsList.style.display = groupsList.style.display === 'none' ? '' : 'none';
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            });
        });

        // Сохранение набора групп
        const saveButton = document.getElementById('saveGroupSet');
        if (saveButton) {
            saveButton.addEventListener('click', function() {
                const groupSetName = document.getElementById('groupSetName').value.trim();
                const selectedGroups = Array.from(document.querySelectorAll('.groupset-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                if (!groupSetName) {
                    alert('Пожалуйста, введите название набора групп');
                    return;
                }

                if (selectedGroups.length === 0) {
                    alert('Пожалуйста, выберите хотя бы одну группу');
                    return;
                }

                // Отправка данных на сервер (нужно будет адаптировать под ваш бэкенд)
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

                const formData = new FormData();
                formData.append('name', groupSetName);
                selectedGroups.forEach(groupId => {
                    formData.append('groups', groupId);
                });

                fetch('{% url "create_tests:save_group_set" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('groupSetModal').classList.remove('active');
                        document.getElementById('successModal').classList.add('active');

                        // Очистка формы
                        document.getElementById('groupSetName').value = '';
                        document.querySelectorAll('.groupset-checkbox').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        updateSelectedGroups();
                    } else {
                        alert('Ошибка при сохранении: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка при отправке данных на сервер');
                });
            });
        }
    });
}

// Функциональность для работы с сохраненными списками групп в модальном окне публикации
function initializeSavedGroupsFeature() {
    const loadSavedGroupsBtn = document.getElementById('loadSavedGroupsBtn');
    const savedGroupsSection = document.getElementById('savedGroupsSection');
    const savedGroupsList = document.getElementById('savedGroupsList');

    if (loadSavedGroupsBtn && savedGroupsSection && savedGroupsList) {
        loadSavedGroupsBtn.addEventListener('click', function() {
            // Переключаем видимость секции
            const isVisible = savedGroupsSection.style.display !== 'none';
            if (isVisible) {
                savedGroupsSection.style.display = 'none';
                this.innerHTML = '<i class="fas fa-bookmark"></i> Мои наборы';
            } else {
                loadSavedGroups();
                savedGroupsSection.style.display = 'block';
                this.innerHTML = '<i class="fas fa-bookmark"></i> Скрыть наборы';
            }
        });
    }
}

function loadSavedGroups() {
    const savedGroupsList = document.getElementById('savedGroupsList');
    if (!savedGroupsList) return;

    // Показываем индикатор загрузки
    savedGroupsList.innerHTML = '<div class="loading">Загрузка...</div>';

    fetch('{% url "create_tests:get_group_lists" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySavedGroups(data.group_lists);
            } else {
                savedGroupsList.innerHTML = '<div class="error">Ошибка: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке списков групп:', error);
            savedGroupsList.innerHTML = '<div class="error">Произошла ошибка при загрузке списков групп</div>';
        });
}

function displaySavedGroups(groupLists) {
    const savedGroupsList = document.getElementById('savedGroupsList');
    if (!savedGroupsList) return;

    if (groupLists.length === 0) {
        savedGroupsList.innerHTML = '<div class="no-groups">У вас пока нет сохраненных наборов групп.</div>';
        return;
    }

    let html = '';
    groupLists.forEach(groupList => {
        html += `
            <div class="saved-group-item" data-list-id="${groupList.id}">
                <div class="group-list-info">
                    <h5>${groupList.name}</h5>
                    <span class="groups-count">${groupList.groups_count} групп</span>
                    <div class="group-preview">
                        ${groupList.groups.slice(0, 3).map(group => `<span class="group-tag">${group.name}</span>`).join('')}
                        ${groupList.groups.length > 3 ? `<span class="more-groups">+${groupList.groups.length - 3}</span>` : ''}
                    </div>
                </div>
                <div class="group-list-actions">
                    <button class="btn btn-sm btn-primary apply-group-list" data-list-id="${groupList.id}">
                        <i class="fas fa-check"></i> Применить
                    </button>
                    <button class="btn btn-sm btn-danger delete-group-list" data-list-id="${groupList.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });

    savedGroupsList.innerHTML = html;

    // Добавляем обработчики событий
    addSavedGroupsEventListeners();
}

function addSavedGroupsEventListeners() {
    // Обработчики для применения списков групп
    document.querySelectorAll('.apply-group-list').forEach(button => {
        button.addEventListener('click', function() {
            const listId = this.getAttribute('data-list-id');
            applyGroupList(listId);
        });
    });

    // Обработчики для удаления списков групп
    document.querySelectorAll('.delete-group-list').forEach(button => {
        button.addEventListener('click', function() {
            const listId = this.getAttribute('data-list-id');
            const listItem = this.closest('.saved-group-item');
            const listName = listItem.querySelector('h5').textContent;

            deleteGroupList(listId, listItem);
        });
    });
}

function applyGroupList(listId) {
    fetch(`{% url "create_tests:get_group_list" list_id=0 %}`.replace('0', listId))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Очищаем все выборы
                document.querySelectorAll('.group-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Выбираем группы из списка
                data.groups.forEach(groupId => {
                    const checkbox = document.querySelector(`#group-${groupId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                alert(`Применен список: ${data.name} (${data.groups.length} групп)`);
            } else {
                alert('Ошибка при применении списка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при применении списка групп');
        });
}

function deleteGroupList(listId, listItem) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

    fetch(`{% url "create_tests:delete_group_list" list_id=0 %}`.replace('0', listId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            listItem.remove();

            // Если больше нет списков, показываем сообщение
            const savedGroupsList = document.getElementById('savedGroupsList');
            if (savedGroupsList && savedGroupsList.querySelectorAll('.saved-group-item').length === 0) {
                savedGroupsList.innerHTML = '<div class="no-groups">У вас пока нет сохраненных наборов групп.</div>';
            }
        } else {
            alert('Ошибка при удалении списка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при удалении списка');
    });
}

// Инициализируем функциональность сохраненных списков
initializeSavedGroupsFeature();
</script>

{% endblock %}